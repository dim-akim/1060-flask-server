# Web-сервер на Flask для школьников. Полный конспект

используются материалы от [HTML Academy][html-academy-link].

## <a id="menu"></a> Оглавление
* [Урок 1](#lesson-1) - Самый простой сервер
* [Урок 2](#lesson-2) - Используем HTML-код
* [Урок 3](#lesson-3) - Используем готовые HTML-страницы
* [Урок 4](#lesson-4) - Настройки и шаблонизатор
* [Урок 5](#lesson-5) - Создаем ссылки с помощью url_for

## <a id="lesson-1"></a> УРОК 1 - Самый простой сервер

<details>
<summary><a id="step-0"></a> Подготовка пространства для работы</summary>

### Создать папку проекта
Для проекта нужна отдельная папка, где будут лежать все материалы, связанные с ним (ее еще называют репозиторием).  
Ее можно назвать `flask-server` или любым другим понятным именем.  
Созданную папку нужно открыть как проект в используемой IDE (например, [PyCharm][pycharm-download-link]):  
`Open Folder as PyCharm Project`

### Создать виртуальное окружение
В только что созданной и открытой папке нужно создать виртуальное окружение. Обычно его помещают в папку `venv`
в корне проекта (англ. _**v**irtual **env**iroment_ - виртуальное окружение):  
```
flask-server/
|-- venv/
```

Это можно сделать двумя способами:
1. Средствами IDE (в PyCharm: _**File**_ -> _**Settings**_ -> _**Project: flask-server**_ -> _**Project Interpreter**_ ->
   <img height="20" src=".\pic\settings-pic.png" width="20"/> -> _**Add**_)
2. Командой в системном терминале `python -m venv venv`

### Установить пакет Flask
Flask устанавливается тоже одним из двух способов:
1. Средствами IDE (в PyCharm: _**File**_ -> _**Settings**_ -> _**Project: flask-server**_  -> _**Project Interpreter**_ ->
   <img height="20" src=".\pic\add-module-pic.png" width="20"/> -> _**Flask**_ -> _**Install Package**_)
2. Командой в системном терминале `pip install flask`.
</details>


[К Оглавлению](#menu)
### <a id="step-1.1"></a> Импортировать основной класс
Код будем писать в файле `server.py`.  
Из пакета flask нужно импортировать класс WCGI-приложения, на основе которого нужно будет создать новый объект:
```python
from flask import Flask
```

### <a id="step-1.2"></a> Создать объект WCGI-приложения
`app` - стандартное имя для переменной основного приложения (англ. _**app**lication_ - приложение). При создании объекта
ему необходимо передать название в качестве первого параметра. Обычно используется атрибут `__name__`:
```python from flask import Flask
app = Flask(__name__)
```

### <a id="step-1.3"></a> Открыть URL на сервере
Чтобы пользователь мог через браузер или другое приложение обратиться по какому-то адресу на сервере, его надо открыть.
Для этого используется декоратор `@app.route()` (англ. *route* - путь). В скобках указывается непосредственный адрес,
по которому можно будет обращаться. По умолчанию при обращении на любой сервер открывается адрес `/`:
```python
@app.route('/')
```

### <a id="step-1.4"></a> Создать функцию представления для открытого пути
Чтобы пользователь мог получить какой-то ответ при запросе по открытому адресу, этот ответ должен быть сформирован
функцией. Она должна быть объявлена сразу под декоратором, открывающим путь (поэтому говорят, что функция
декорирована), и возвращать строку, которую потом сможет интерпретировать браузер:
```python
@app.route('/')
def hello():
    return 'Hello, World!'
```

### <a id="step-1.5"></a> Сделать возможным запуск сервера
Сервер запускается с помощью метода `run` объекта `app`.  
Хорошим тоном считается вызывать этот метод только в том случае, если `server.py` запускается напрямую.
В этом случае его атрибут `__name__` (т.е. название скрипта) примет значение `__main__`, а не `server.py`,
как было бы при его импорте. Для того чтобы учесть эту ситуацию, есть специальная конструкция (в PyCharm ее можно
получить, просто набрав слово `main` и нажав **Enter**):
```python
if __name__ == '__main__':
    app.run()
```
Теперь, **если** запустить `server.py` напрямую, как **главный** файл, произойдет старт приложения,
а если импортировать его в другой проект, строчка `app.run()` выполнена не будет.

### <a id="step-1.6"></a> Проверить работоспособность сервера
При запуске сервера (в PyCharm: сочетание клавиш `Ctrl` + `Shift` + `F10`) в консоли появится служебное сообщение и
адрес сервера, которое можно ввести в адресной строке браузера или просто щелкнуть по нему мышкой.

По умолчанию используется IP-адрес `127.0.0.1` и порт `5000` (говорят, что приложение слушает определенный адрес
и определенный порт). Этот адрес указывает компьютеру, что нужно обратиться к самому себе — т.е. зайти на этот адрес
получиться только с того компьютера, на котором запущено приложение.

Изменить эти настройки можно, указав дополнительные параметры `host` (строка) и `port` (целое число) методу `run`.
Например, следующий код сделает сервер видимым извне (т.е. к нему можно будет подключиться с другого компьютера):
```python
if __name__ == '__main__':
    app.run(host='0.0.0.0')
```
Открыв адрес сервера в браузере, можно увидеть фразу `Hello, World!`, которую возвращает наша функция `hello`.
Вернувшись в консоль, можно обнаружить, что сервер отчитался о полученном запросе - метод `GET`, адрес `/` и
код ответа `200`.

### Структура проекта
```
flask-server/
|-- venv/
|-- server.py
```

## <a id="lesson-2"></a> УРОК 2 - Используем HTML-код
[К Оглавлению](#menu)
### <a id="step-2.1"></a> Создать новый URL
Обращаясь по определенному URL, браузер ожидает получить в ответ файл (или, как в случае нашего сервера, текст).
Если же по запрошенному адресу находится не файл, а каталог (по-другому папка), то web-сервер, обслуживающий сайт,
все равно должен будет вернуть браузеру какой-то файл, чтобы тот мог его отобразить пользователю. По умолчанию это будет
перечисление всего содержимого каталога - т.е. его индекс (англ. _index_ можно перевести как указатель или номер), что может
оказаться неудобным, некрасивым и даже небезопасным. Пример можно увидеть, пройдя по адресу <https://mirror.yandex.ru/>
(у каждой папки будет свой собственный индекс, т.е. список содержимого).

Чтобы не попадать в подобные ситуации, индексный файл стали переопределять - т.е. создавать свой собственный файл
`index.html` (расширение может быть другим, например, `.htm` или `.php`), в который помещали стартовую страницу каталога.  
Индексный файл корневой папки, таким образом, становился главной страницей всего сайта.
Любой современный web-сервер можно настроить так, чтобы в качестве файла по умолчанию он отдавал любой файл с любым
именем, но все равно исторически повелось, что главную страницу именуют словом `index`.

Мы откроем путь по этому адресу и создадим одноименную функцию представления:
```python
@app.route('/index')
def index():
    pass
```

### <a id="step-2.2"></a> Вернуть HTML-код
Сайты в интернете написаны на языке HTML (_**H**yper **T**ext **M**arkup **L**anguage_ - язык разметки гипертекста),
который указывает браузеру, как именно отображать тот или иной элемент (чаще всего текст или картинку), с помощью
специальных тегов, заключенных в угловые скобки. Базовое знание языков HTML и CSS (он используется для стилизации страниц,
размеченных HTML) необходимо при создании web-серверов, поэтому рекомендуется пройти [небольшой курс][basic-html-css-link]
по знакомству с этими языками от HTML Academy.

> #### <a id="step-2.3"></a> Кратко о структуре HTML
> 
> Документ HTML всегда начинается с декларации его типа: `<!DOCTYPE html>` - это одиночный тег, который сообщает браузеру,
как именно надо интерпретировать полученный файл. Большинство других тегов работают в паре, состоящей из открывающего
и закрывающего тегов, в которые **оборачивается** содержимое (оно, в свою очередь, может быть завернуто в другие теги).
В частности, все содержимое документа HTML после декларации должно находиться внутри тега `html`. Оно должно состоять
из двух частей - блок `head`, куда помещается служебная информация для браузера (например, подключение стилей или
заголовок страницы, который отображается на вкладке в браузере) и блок `body`, где лежит непосредственно содержание
страницы для отображения пользователю в окне браузера.

Для того чтобы превратить обычный текст, возвращаемый функцией `hello`, в полноценный HTML-документ, нужно выстроить
базовую структуру документа тегами, внутрь тега `head` добавить заголовок, обернутый в тег `title`, а также обернуть фразу
`Hello, World!` в любой тег на ваш выбор (например, в тег заголовка первого уровня `h1`). Все это можно записать одной
строчкой, но гораздо удобнее видеть структуру вложенности тегов друг в друга:
```python
def index():
    return '''
    <!DOCTYPE html>
    <html>
      <head>
        <title>Flask Server</title>
      </head>
      <body>
        <h1>Hello, World!</h1>
      </body>
    </html>
    '''
```
Если добавить в блок body еще несколько тегов (например, `<h2>`, `<p>`, `<b>`, `<i>`), можно наглядно увидеть разницу.

### <a id="step-2.4"></a> Запустить сервер
При добавлении новой функции или изменении старой необходимо в обязательном порядке заново запускать сервер и проверять
работоспособность всех открытых путей. Чтобы попасть на страницу `/index`, нужно зайти на свой сервер, а затем вручную
дописать этот адрес в адресной строке браузера. По умолчанию должно получиться `http://127.0.0.1:5000/index`.

## <a id="lesson-3"></a> УРОК 3 - Используем готовые HTML-страницы
[К Оглавлению](#menu)

### <a id="step-3.1"></a> Зачем использовать готовые HTML-страницы?
Писать в каждой функции возврат в виде HTML-кода получится слишком накладно:
+ код получится очень громоздким, потому что каждая страница будет занимать много строк;
+ синтаксис HTML-кода внутри строки Python не подсвечивается, что сильно затрудняет разработку и отладку

Гораздо проще взять уже готовые HTML-страницы и использовать их в своем сервере.

Таким образом происходит разделение полномочий:
+ Код на Python отвечает за логику происходящего. Это называют бэкендом (англ. _back_ - задняя сторона, спина).
+ Код на HTML (а возможно, еще и на JavaScript) отвечает за внешний вид. Это называют фронтендом
  (англ. _front_ - передняя сторона, внешняя часть).

### <a id="step-3.2"></a> Скачать и распаковать архив с сайтом
Обычный статичный сайт представляет собой папку с одной или несколькими HTML-страницами, файлом стилей
(их тоже может быть несколько), а также дополнительных каталогов с изображениями и другими файлами.

На [курсе от HTML Academy][basic-html-css-link] создавался небольшой блог (архив лежит
[по этой ссылке][web-designer-blog-link]), который отлично подходит для того, чтобы использовать его в качестве шаблона.

В архиве лежит две папки - `_MACOSX` и `project-state-final`. Вторую из них нужно распаковать
в корень директории с проектом (мы ее создавали на при [подготовке пространства для работы](#step-0)).

### <a id="step-3.3"></a> Выстроить структуру каталогов
При написании проектов на Flask принято придерживаться следующей структуры:
+ Директория `templates` предназначена для шаблонов (в нашем случае это HTML-страницы, но шаблонами могут выступать
  и другие файлы).
+ В директорию `static` нужно будет поместить редко изменяемые, т.е. статичные, файлы (в нашем случае -
  файл `style.css`, папки `img` и `files`). Для файлов `.css`, при желании, можно создать дополнительный каталог.
Обе директории должны лежать в корне проекта.

### <a id="step-3.4"></a> Изменить функцию index
Теперь нужно импортировать функцию `render_template` (англ. _render_ - отображать, предоставлять), которая позволит
превратить содержимое шаблона `index.html` в текст, и его можно будет вернуть в функции представления.
Ее нужно импортировать из пакета `flask`:
```python
from flask import Flask, render_template
```
Нужно изменить функцию index: вместо текста она должна возвращать результат вызова импортированной только что функции.
Первым параметром мы должны передать название шаблона:
```python
def index():
    return render_template('index.html')
```

### <a id="step-3.5"></a> Запустить сервер
Надо не забыть запустить сервер и проверить, что при переходе на страницу `http://127.0.0.1:5000/index` теперь
открывается главная страница Сайта начинающего верстальщика.

**ПРОБЛЕМА** - не подключился файл стилей и картинки. Будет решаться на [уроке 5](#lesson-5).

<details>
<summary><a id="step-3.6"></a> Решение проблемы</summary>

В коде страницы `index.html` (на 6 строке) можно увидеть, что файл стилей будет искаться в том же каталоге, где находится
ресурс `index`. В рамках нашей структуры каталогов поиск нужно вести в папке `static/css/`. Если скорректировать ссылку,
стили подгрузятся, и главную страницу можно будет увидеть в полном оформлении.

Этот способ не является оптимальным и работает только в рамках текущих знаний ученика. На [уроке 5](#lesson-5) будет
показано другое, более правильное с точки зрения организации сервера решение.
</details>

**ПРОБЛЕМА** - каждый раз руками вписывать `index` в адресной строке - неудобно.

<details>
<summary><a id="step-3.7"></a> Решение проблемы</summary>

Можно немного изменить функцию `hello`. Если вместо простого приветствия туда добавить соответствующую ссылку
с помощью html-тега `<a>`, можно будет переходить на страницу index, просто щелкнув мышкой по ссылке. Потом здесь
появится больше ссылок, поэтому возврат можно сразу сделать многострочным:
```python
def hello():
    return """
    <h1>Добро пожаловать на сервер flask-server</h1>
    Ссылка на <a href="index">index</a> страницу<br>
    """
```
</details>

### <a id="step-3.9"></a> Структура проекта
```
flask-server/
|-- static/
|   |-- css/
|   |   |-- style.css
|   |   
|   |-- files/
|   |   |-- gifka.gif
|   |   |-- instruktor-keks.jpg
|   |   |-- keks-1.jpg
|   |   |-- keks-2.jpg
|   |   |-- keks-3.jpg
|   |   |-- portrait.png
|   |   |-- preview-1.jpg
|   |   |-- preview-2.jpg
|   |   |-- preview-3.jpg
|   |   |-- recipe.pdf
|   |   
|   |-- img/
|       |-- bg-page.png
|       |-- bg-partnership.svg
|       |-- raccoon.svg
|
|-- templates/
|   |-- day-1.html
|   |-- ...
|   |-- day-15.html
|   |-- index.html
|   |-- photo-1.html
|   |-- photo-2.html
|   |-- photo-3.html
|   
|-- venv/
|-- server.py
```

## <a id="lesson-4"></a> УРОК 4 - Настройки и шаблонизатор
[К Оглавлению](#menu)
### <a id="step-4.1"></a> Настроить IDE для работы с проектом на Flask
В некоторых IDE есть возможность включить поддержку Flask. Это позволит программе, например, видеть шаблоны
в папке `templates` и подсказывать их названия, а кроме того, появится ряд дополнительных настроек.  
В PyCharm для этого нужно открыть окно настроек **_File_** -> **_Settings_** (или сочетанием клавиш `Ctrl` + `Alt` + `S`),
а затем:
1. установить флажок **_Languages and Frameworks_** -> **_Flask_** -> **_Flask Integration_**,
2. перейти в меню **_Project: flask-server_** -> **_Project Structure_** и отметить папку `templates` в качестве
   источника шаблонов (Templates Folder).

Теперь в PyCharm, напротив имени объявленной функции (в нашем случае `index`), появится дополнительная иконка
<img height="20" src=".\pic\view-icon.png" width="20"/>, при нажатии на которую откроется для редактирования
связанный с этой функцией шаблон. В шаблоне эта же иконка позволит переместиться обратно к функции представления.

### <a id="step-4.2"></a> Настроить IDE для работы с шаблонизатором Jinja2
В проектах на Flask используется язык для шаблонов Jinja2, поддержку которого тоже можно включить в настройках IDE.  
Например, в PyCharm:
1. Открываем настройки (**_File_** -> **_Settings_** или `Ctrl` + `Alt` + `S`),
2. переходим в раздел **_Languages and Frameworks_** -> **_Template languages_**,
3. в раскрывающемся списке выбираем язык **_Jinja2_** и нажимаем `OK`.

Теперь при редактировании шаблонов будут доступны для автозаполнения конструкции языка Jinja2.

### <a id="step-4.3"></a> Передать значение внутрь шаблона
Шаблон так называется потому, что туда можно подставлять какие-то дополнительные значения, которые, например,
были вычислены в функции представления. Самое простое - указать какую-то дополнительную информацию в заголовке.
Для этого нужно передать эту информацию функции, обрабатывающей шаблон, в качестве именованного параметра.
Имя для параметра нужно выбрать самому и запомнить - его надо будет потом использовать в шаблоне:
```python
def index():
    return render_template('index.html', username='dim-akim')
```
Можно предварительно создать переменную для этого значения, и передать в функцию переменную. Так удобно делать,
если нужны какие-то промежуточные действия:
```python
def index():
    name = 'dim'
    name += '-akim'
    return render_template('index.html', username=name)
```
Третий способ - представить данные в виде словаря. Тогда передавать значение можно по конкретному ключу или же
"раскрывая" словарь с помощью двойной звездочки перед его именем:
```python
# 1 вариант
def index():
    user = {'username': 'dim-akim'}
    return render_template('index.html', username=user['username'])
```
```python
# 2 вариант
def index():
    user = {'username': 'dim-akim'}
    return render_template('index.html', **user)  # раскроется в username='dim-akim'
```

### <a id="step-4.4"></a> Использовать переменную в шаблоне
В шаблоне нужно указать место, куда будет подставлена переменная с выбранным именем, используя язык Jinja2, т.е.
заключив имя переменной в двойные фигурные скобки `{{ username }}`. Имя переменной надо использовать такое же,
какое было передано в функцию render_template. Использовать его можно, например, на **10 строке**, тем самым уточнив,
кто именно является начинающим верстальщиком:
```html
<h1 class="page-title">Сайт начинающего верстальщика {{ username }}</h1>
```
Если в функцию не передать переменную (или использовать другое имя), то на этом месте ничего не появится.  
При необходимости, можно использовать несколько именованных параметров, и подставлять в шаблон несколько значений.

### <a id="step-4.5"></a> Запустить сервер
Не забываем запустить сервер и убедиться, что новые данные подставились в нужное место на Главной странице.

### <a id="step-4.6"></a> Практика
Можно попрактиковаться, передав в шаблон дополнительные переменные и отобразив их в разных местах на странице.  
Или можно попробовать решить проблемы, обозначенные на [предыдущем уроке](#step-3.5).

## <a id="lesson-5"></a> УРОК 5 - Автоматическое создание ссылок с помощью url_for
[К Оглавлению](#menu)
### <a id="step-5.1"></a> Починить подключение стилей и картинок статично
Проблема, проявившаяся на [уроке 3](#step-3.5), связана с принципами работы ссылок (их еще называют гиперссылками -
_hyperlink_). 
> #### <a id="step-5.2"></a> Кратко о ссылках в HTML
> 
> Любая гиперссылка, которая появляется в адресной строке браузера, состоит из нескольких частей: протокола, имени
> (или, реже, IP-адреса) домена и пути до файла. Опционально там могут появиться еще параметры запроса и якорь на странице.
> 
> Например, в ссылке `https://htmlacademy.ru/assets/courses/309/project-state-final.zip?n`:
> * **https://** - означает, что запрос осуществляется по протоколу HTTPS
> * **htmlacademy.ru** - имя домена, где располагается нужный нам ресурс
> * **/assets/courses/309/** - расположение ресурса внутри домена
> * **project-state-final.zip** - имя ресурса (в данном случае - файла, который браузер скачает)
> * **?n** - параметры запроса, передаваемые серверу (чаще используют структуру словаря **ключ=значение**, например `n=123`)
> * якоря (места на странице, куда браузер перемотает содержимое) в этой ссылке нет, он имел бы вид **#example**
> 
> Гиперссылка в HTML-документе может быть **абсолютной** или **относительной**.  
> Абсолютная ссылка будет содержать в себе все перечисленные выше части, кроме, возможно, двух последних.  
> В относительной ссылке будет только часть URL-адреса. В этом случае недостающее начало ссылки браузер будет подставлять
> из той, где он в данный момент находится (т.е. которая прописана в адресной строке). Какая именно часть -
> определяется структурой относительной ссылки.
> 
> Например, если бы по ссылке `https://htmlacademy.ru/assets/courses/309/project-state-final.html` находился документ, в котором можно было бы пройти по другой ссылке:
> * **/courses/basic-html-css** превратится в `https://htmlacademy.ru/` `courses/basic-html-css` (ссылка относительно домена)
> * **basic-html-css** - в `https://htmlacademy.ru/assets/courses/309/` `basic-html-css` (ссылка относительно текущего расположения)
> * **?name=dim-akim&age=34** - в `https://htmlacademy.ru/assets/courses/309/project-state-final.html` `?name=dim-akim&age=34` (ссылка относительно текущего документа)
> * **#example** - в `https://htmlacademy.ru/courses/assets/courses/309/project-state-final.html` `#example` (якорь в пределах текущего документа)

Ссылки внутри файла `index.html` являются относительными. В нашем случае файлы стилей и картинок браузер пытается найти
в том же каталоге, где находится ресурс `index`, т.е. в корне сервера (не путать с шаблоном `index.html`, который лежит
в папке templates!).

Очевидным решением кажется добавление к ссылкам внутри шаблона имя папки со статичными ресурсами
(т.е. `static/css/style.css` на 6 строке и `static/img/raccoon.svg` на 14 строке)

### <a id="step-5.3"></a> Изменить адрес ресурса /index
При размещении приложения на другом web-сервере, или при разрастании сайта, может измениться структура каталогов, или
адрес исходного ресурса. Например, блог может переехать по адресу `blog/index.html`.

Надо смоделировать эту ситуацию, изменив адрес для функции представления index
(такую функцию еще называют `endpoint`, англ. _конечная точка_)

Если запустить сервер, можно увидеть, что стили опять перестали отображаться.

### <a id="step-5.4"></a> Использовать автоматическую генерацию ссылок
Для работы со ссылками в пакете Flask есть специальная функция `url_for` (англ. _ссылка\_для_). Ей нужно передать название
функции представления, и она сама генерирует ссылку на ресурс, вынув ее из соответствующего декоратора `@app.route`.
Если же первым параметром для функции `url_for` указать слово `static`, то появится возможность получить ссылку на
какой-либо статичный ресурс с помощью именованного аргумента `filename`. Эта функция работает как в тексте программы,
так и внутри шаблонов.

В файле `index.html` должны произойти изменения на **6 строке**:
```html
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
```
И на 14 строке:
```html
<img class="avatar" src="{{ url_for('static', filename='img/raccoon.svg') }}" width="80" height="80" alt="Аватарка">
```
Теперь после запуска сервера все стили должны опять подключиться. Можно поэкспериментировать, изменяя ссылку на
функцию представления `index`.

**ПРОБЛЕМА** - в файле `index.html` есть гиперссылки на другие страницы блога. На этих страницах функция `url_for`
не сработает, потому что для этих страниц нет соответствующих функций представления. Будет решаться на уроке 6.

### <a id="step-5.4"></a> Использовать url_for в функции hello
Если на [уроке 3](#step-3.7) не была вписана ссылка страницу `index` в функцию `hello`, самое время это сделать.  
Тогда каждый раз при запуске сервера можно будет переходить на страницу `index`, щелкая по ссылке,
а не вводя ее в адресную строку.

Здесь можно использовать ту же самую функцию `url_for`. Ее надо импортировать из модуля Flask.  
Для вставки функции в строку можно использовать f-строку или другой удобный способ форматирования строки.
```python
def hello():
    return f"""
    <h1>Добро пожаловать на сервер flask-server</h1>
    Ссылка на <a href="{url_for('index')}">index</a> страницу<br>
    """
```


[html-academy-link]: https://htmlacademy.ru/ "Обучение HTML и CSS"
[pycharm-download-link]: https://www.jetbrains.com/pycharm/download/ "Скачать PyCharm"
[basic-html-css-link]: https://htmlacademy.ru/courses/basic-html-css "Знакомство с HTML и CSS"
[web-designer-blog-link]: https://htmlacademy.ru/assets/courses/309/project-state-final.zip?n "Сайт начинающего верстальщика"
